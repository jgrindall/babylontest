


<html>
    <head>
        <script src='babylon.custom.cannon.js'></script>
        <script src='jquery.js'></script>
        <script src='hand.js'></script>
        <script src='underscore-min.js'></script>
        <script src='nipplejs.min.js'></script>
        <script src='greedymesh.js'></script>

        <style>
            #renderCanvas{
                width:100%;
                height:100%;
            }
			#zone_joystick{
                position: absolute;
                bottom:90px;
                right:90px;
            }
        </style>
    </head>
    <body>
	
        <canvas width='100%' height='100%' id="renderCanvas"></canvas>
		<div id="zone_joystick"></div>

        <script>
            var canvas, scene, engine, player, angle = 0;
			var _mode = "off";
			canvas = document.querySelector("#renderCanvas");
			var SIZE_I = 24;
			var SIZE_J = 32;
			var SIZE = 5;
			
			
            var speed = 0, ang_speed = 0, angle = 0, friction = 0.75;
			
			var makeMaterials = function(){
                brickMaterial = new BABYLON.StandardMaterial("brickMaterial", scene);
                brickMaterial.diffuseTexture = new BABYLON.Texture("brick.jpg", scene);
                brickMaterial.backFaceCulling = false
                brickMaterial.freeze();
                steelMaterial = new BABYLON.StandardMaterial("steelMaterial", scene);
                steelMaterial.diffuseTexture = new BABYLON.Texture("steel.jpg", scene);
                steelMaterial.backFaceCulling = false
                steelMaterial.freeze();
            };
			
			var setUVScale = function(mesh, uScale, vScale) {
				var i, UVs = mesh.getVerticesData(BABYLON.VertexBuffer.UVKind), len = UVs.length;
				if (uScale !== 1) {
					for (i = 0; i < len; i += 2) {
						UVs[i] *= uScale;
					}
				}
				if (vScale !== 1) {
					for (i = 1; i < len; i += 2) {
						UVs[i] *= vScale;
					}
				}
				mesh.setVerticesData(BABYLON.VertexBuffer.UVKind, UVs);
			};
			
			var cache = {};
			
			var makeCache = function(size){
				var key = "brick_" + size[0] + "_" + size[1];
				var box = BABYLON.MeshBuilder.CreateBox(key, {height: SIZE, width:SIZE*size[0], depth:SIZE*size[1]}, scene);
				box.convertToUnIndexedMesh();
				box.material = brickMaterial;
				box.checkCollisions = true;
				setUVScale(box, size[0], size[1]);
				cache[key] = box;
				scene.meshes.pop(); // remove from the scene
			};
			var cacheI = 0;
			var getFromCache = function(size){
				var key = "brick_" + size[0] + "_" + size[1];
				var cached = cache[key];
				cacheI++;
				var box = cached.createInstance("_" + cacheI);
				box.checkCollisions = true;
				return box;
			};
			
			var addControls = function(){
				var ROT_SPEED = 0.025, SPEED = 0.6;
				var manager = nipplejs.create({
					zone: document.getElementById('zone_joystick'),
					mode: 'static',
					size:80,
					position: {
					  left: '50%',
					  top: '50%'
					},
					color: 'red'
				});

				manager.on("dir:up", function(e, data){
					_mode = "on";
					speed = SPEED;
					ang_speed = 0;
					console.log(data);
				});

				manager.on("dir:left", function(e, data){
					_mode = "on";
					speed = 0;
					ang_speed = -ROT_SPEED;
					angle -= 0.1;
				});

				manager.on("dir:right", function(e, data){
					_mode = "on";
					speed = 0;
					ang_speed = ROT_SPEED;
					angle += 0.1;
				});

				manager.on("dir:down", function(e, data){
					_mode = "on";
					speed = -SPEED;
					ang_speed = 0;
				});

				manager.on("end", function(e, data){
					_mode = "off";
					ang_speed = 0;
					//speed = 0;
				});

			};

            var makeScene = function () {
                scene = new BABYLON.Scene(engine);
				scene.enablePhysics();
				var light0 = new BABYLON.DirectionalLight("Omni", new BABYLON.Vector3(-2, -5, 2), scene);
				var light1 = new BABYLON.PointLight("Omni", new BABYLON.Vector3(2, -5, -2), scene);
				camera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(SIZE_I*SIZE/2, 350, SIZE_J*SIZE/2), scene);
				//camera.attachControl(canvas, true);
				//camera.rotation = new BABYLON.Vector3(Math.PI/2, 0 , 0);
				var ground = BABYLON.Mesh.CreatePlane("ground", 2000.0, scene);
				ground.material = new BABYLON.StandardMaterial("groundMat", scene);
				ground.material.diffuseColor = new BABYLON.Color3(1, 1, 1);
				ground.material.backFaceCulling = false;
				ground.position = new BABYLON.Vector3(5, -10, -15);
				ground.rotation = new BABYLON.Vector3(Math.PI / 2, 0, 0);
				scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
				scene.collisionsEnabled = true;
				camera.checkCollisions = true;
				camera.applyGravity = true;
				camera.ellipsoid = new BABYLON.Vector3(5, 1, 5);
				ground.checkCollisions = true;
            }
			
			
			var movePlayer = function(){
                var dx, dz;
                var fps = engine.getFps();
				player.rotation.y = angle;
                dx = speed*Math.sin(angle) * (60/fps);
                dz = speed*Math.cos(angle) * (60/fps);
				player.checkCollisions = true;
				player.isVisible = false;
                player.moveWithCollisions(new BABYLON.Vector3(dx, 0, dz));
				console.log("move with coll", dx, dz);
                //camera.position.x = player.position.x;
                //camera.position.y = player.position.y;
                //camera.position.z = player.position.z;
            }
			
			var ijToBabylon = function(i, j){
				var topLeft = {"x":0, "z":SIZE_I * SIZE};
				return {
					x:topLeft.x + j*SIZE,
					z:topLeft.z - i*SIZE
				};
			};
			
			var addPlayer = function(pos){
                var mat = new BABYLON.StandardMaterial("Mat", scene);
				mat.diffuseTexture = new BABYLON.Texture("img/skybox_nx.jpg", scene);
				mat.backFaceCulling = false;
				var babylonPos = ijToBabylon(pos[0], pos[1]);
                player = BABYLON.MeshBuilder.CreateBox("player", {height: 1, width:1, depth:1}, scene);
                player.material = mat;
                player.checkCollisions = true;
                player.position = new BABYLON.Vector3(babylonPos.x, -7, babylonPos.z);
                player.ellipsoid = new BABYLON.Vector3(SIZE/3, SIZE/3, SIZE/3);
                player.setPhysicsState(BABYLON.PhysicsEngine.SphereImpostor, { mass: 0 });
            };
			
			var addWalls = function(quads){
				var y = -SIZE*1.5;
				var topLeft = {"x":0, "z":SIZE_I * SIZE};
				_.each(quads, function(quad){
					var size = (quad[2] >= quad[3]) ? [quad[2], quad[3]] : [quad[3], quad[2]]; // long and thin only
					var wall = getFromCache(size);
					if(quad[2] < quad[3]){
						wall.rotation = new BABYLON.Vector3(0, Math.PI/2, 0);
					}
					wall.position.x = topLeft.x + (quad[1] + quad[2]/2)*SIZE;
					wall.position.z = topLeft.z - (quad[0] + quad[3]/2)*SIZE;
					wall.position.y = y;
					console.log("quad is", JSON.stringify(quad));
					console.log(wall.position);
					wall.freezeWorldMatrix();
				});
			};
			
			var birdsEye = function(){
				camera.rotation = new BABYLON.Vector3(Math.PI/2, 0 , 0);
			};
			
			engine = new BABYLON.Engine(canvas, false, null, false);
			makeScene();
			addControls();
			makeMaterials();
			
			var img = makeRnd({rnd:0.2});
			var greedy = getBestGreedyMesh(img);
			_.each(greedy.dims, function(size){
				makeCache(size);
			});
			
			addWalls(greedy.quads);
			var empty = getEmpty(img);
			addPlayer(empty);
			birdsEye();
			
			
			//scene.debugLayer.show();
            engine.runRenderLoop(function () {
				if(_mode !== "off" && speed !== 0){
                    movePlayer();
                }
                if(_mode === "off"){
                    ang_speed *= friction;
                    speed *= friction;
                    if(Math.abs(speed) < 0.1){
                        speed = 0;
                    }
                }
                scene.render();
            });
            window.addEventListener("resize", function () {
               engine.resize();
            });
        </script>
    </body>
</html>
