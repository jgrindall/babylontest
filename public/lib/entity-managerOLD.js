!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.ensy=n()}(this,function(){"use strict";function t(n){if(null==n||"object"!=(void 0===n?"undefined":e(n)))return n;var o=void 0;if(n instanceof Date)return o=new Date,o.setTime(n.getTime()),o;if(n instanceof Array){o=[];for(var i=0,r=n.length;i<r;i++)o[i]=t(n[i]);return o}if(n instanceof Object){o={};for(var s in n)n.hasOwnProperty(s)&&(o[s]=t(n[s]));return o}}function n(t){return t&&"[object Function]"==={}.toString.call(t)}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(n,e,o){return e&&t(n.prototype,e),o&&t(n,o),n}}();return function(){function e(t){o(this,e),this.listener=null,t&&n(t.emit)&&(this.listener=t),this.entities=[],this.components={},this.assemblages={},this.entityComponentData={},this.processors=[],this.uid=0}return i(e,[{key:"getUid",value:function(){return this.uid++}},{key:"createEntity",value:function(t,n){return void 0===n||null===n?n=this.getUid():n>this.uid&&(this.uid=n),this.addComponentsToEntity(t,n),this.entities.includes(n)||this.entities.push(n),this.listener&&this.listener.emit("entityCreated",n),n}},{key:"removeEntity",value:function(t){for(var n in this.entityComponentData)this.entityComponentData.hasOwnProperty(n)&&this.entityComponentData[n][t]&&delete this.entityComponentData[n][t];return this.entities.splice(this.entities.indexOf(t),1),this.listener&&this.listener.emit("entityCreated",t),this}},{key:"addComponent",value:function(t,n){return this.components[t]=n,this}},{key:"removeComponent",value:function(t){return delete this.components[t],delete this.entityComponentData[t],this}},{key:"getComponentsList",value:function(){return Object.keys(this.components)}},{key:"addComponentsToEntity",value:function(n,e){var o=this,i=this;return n.forEach(function(t){if(!o.components[t])throw new Error("Trying to use unknown component: "+t)}),n.forEach(function(n){o.entityComponentData[n]||(o.entityComponentData[n]={});var r=null;o.listener?(r={},function(n,o){var r=t(i.components[o].state);for(var s in r)r.hasOwnProperty(s)&&function(t){Object.defineProperty(n,t,{enumerable:!0,get:function(){return r[t]},set:function(n){r[t]=n,i.listener.emit("entityComponentUpdated",e,o)}})}(s)}(r,n)):r=t(i.components[n].state),r.__id=e,o.entityComponentData[n][e]=r,o.listener&&o.listener.emit("entityComponentAdded",e,n)}),this}},{key:"removeComponentsFromEntity",value:function(t,n){var e=this;return t.forEach(function(t){if(!e.components[t])throw new Error("Trying to use unknown component: "+t)}),t.forEach(function(t){e.entityComponentData[t]&&e.entityComponentData[t][n]&&(delete e.entityComponentData[t][n],e.listener&&e.listener.emit("entityComponentRemoved",n,t))}),this}},{key:"getComponentDataForEntity",value:function(t,n){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);if(!this.entityComponentData.hasOwnProperty(t)||!this.entityComponentData[t].hasOwnProperty(n))throw new Error("No data for component "+t+" and entity "+n);return this.entityComponentData[t][n]}},{key:"updateComponentDataForEntity",value:function(t,n,e){var o=this.getComponentDataForEntity(t,n);for(var i in e)e.hasOwnProperty(i)&&o.hasOwnProperty(i)&&(o[i]=e[i]);return this}},{key:"getComponentsData",value:function(t){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);return this.entityComponentData.hasOwnProperty(t)?this.entityComponentData[t]:[]}},{key:"entityHasComponent",value:function(t,n){return n in this.components&&(this.entityComponentData.hasOwnProperty(n)&&this.entityComponentData[n].hasOwnProperty(t))}},{key:"addAssemblage",value:function(t,n){return this.assemblages[t]=n,this}},{key:"removeAssemblage",value:function(t){return delete this.assemblages[t],this}},{key:"createEntityFromAssemblage",value:function(t){if(!(t in this.assemblages))throw new Error("Trying to use unknown assemblage: "+t);var n=this.assemblages[t],e=this.createEntity(n.components);for(var o in n.initialState)if(n.initialState.hasOwnProperty(o)){var i=n.initialState[o];this.updateComponentDataForEntity(o,e,i)}return e}},{key:"addProcessor",value:function(t){return this.processors.push(t),this}},{key:"removeProcessor",value:function(t){return this.processors.splice(this.processors.indexOf(t),1),this}},{key:"update",value:function(t){return this.processors.forEach(function(n){return n.update(t)}),this}}]),e}()});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjpudWxsLCJzb3VyY2VzIjpbInNyYy9lbnRpdHktbWFuYWdlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIGVuc3kgLSBFbnRpdHkgU3lzdGVtIEphdmFTY3JpcHQgTGlicmFyeSB2MS4zLjBcbiAqXG4gKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIEVudGl0eSBTeXN0ZW0gbW9kZWwgYXMgZGVzY3JpYmVkIGJ5XG4gKiBBZGFtIE1hcnRpbiBpbiBodHRwOi8vdC1tYWNoaW5lLm9yZy9pbmRleC5waHAvMjAwOS8xMC8yNi9lbnRpdHktc3lzdGVtcy1hcmUtdGhlLWZ1dHVyZS1vZi1tbW9zLXBhcnQtNS9cbiAqXG4gKiBAYXV0aG9yIEFkcmlhbiBHYXVkZWJlcnQgLSBhZHJpYW5AZ2F1ZGViZXJ0LmZyXG4gKiBAbGljZW5zZSBNSVQgbGljZW5zZS5cbiAqIEBkb2N1bWVudGF0aW9uIGh0dHBzOi8vZW50aXR5LXN5c3RlbS1qcy5yZWFkdGhlZG9jcy5pby9cbiAqXG4gKi9cblxuLyohXG4gKiBSZXR1cm4gYSBjbG9uZSBvZiBhbiBvYmplY3QuXG4gKiBGcm9tIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzcyODM2MFxuICovXG5mdW5jdGlvbiBjbG9uZShvYmopIHtcbiAgICAvLyBIYW5kbGUgdGhlIDMgc2ltcGxlIHR5cGVzLCBhbmQgbnVsbCBvciB1bmRlZmluZWRcbiAgICBpZiAobnVsbCA9PSBvYmogfHwgJ29iamVjdCcgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG9iajtcblxuICAgIGxldCBjb3B5O1xuXG4gICAgLy8gSGFuZGxlIERhdGVcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBjb3B5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29weS5zZXRUaW1lKG9iai5nZXRUaW1lKCkpO1xuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgQXJyYXlcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgY29weSA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gb2JqLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICBjb3B5W2ldID0gY2xvbmUob2JqW2ldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgT2JqZWN0XG4gICAgaWYgKG9iaiBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICBjb3B5ID0ge307XG4gICAgICAgIGZvciAobGV0IGF0dHIgaW4gb2JqKSB7XG4gICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGF0dHIpKSBjb3B5W2F0dHJdID0gY2xvbmUob2JqW2F0dHJdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG59XG5cbi8qIVxuICogUmV0dXJuIHRydWUgaWYgdGhlIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uLlxuICogRnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTk5OTk4XG4gKi9cbmZ1bmN0aW9uIGlzRnVuY3Rpb24odGhpbmdUb0NoZWNrKSB7XG4gICAgcmV0dXJuIHRoaW5nVG9DaGVjayAmJiAoe30pLnRvU3RyaW5nLmNhbGwodGhpbmdUb0NoZWNrKSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJztcbn1cblxuLyoqXG4gKiBAY2xhc3MgRW50aXR5TWFuYWdlclxuICpcbiAqIEltcGxlbWVudCB0aGUgRW50aXR5IFN5c3RlbSBtb2RlbCBhbmQgcHJvdmlkZSB0b29scyB0byBlYXNpbHlcbiAqIGNyZWF0ZSBhbmQgbWFuaXB1bGF0ZSBFbnRpdGllcywgQ29tcG9uZW50cyBhbmQgUHJvY2Vzc29ycy5cbiAqL1xuY2xhc3MgRW50aXR5TWFuYWdlciB7XG4gICAgY29uc3RydWN0b3IobGlzdGVuZXIpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG51bGw7XG4gICAgICAgIGlmIChsaXN0ZW5lciAmJiBpc0Z1bmN0aW9uKGxpc3RlbmVyLmVtaXQpKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBIGxpc3Qgb2YgZW50aXR5IElEcywgZWFjaCBiZWluZyBhIHNpbXBsZSBpbnRlZ2VyLlxuICAgICAgICB0aGlzLmVudGl0aWVzID0gW107XG5cbiAgICAgICAgLy8gQSBkaWN0aW9uYXJ5IG9mIGNvbXBvbmVudHMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gY29tcG9uZW50LiBDb21wb25lbnRzIGFyZSBvYmplY3RzIGNvbnRhaW5pbmc6XG4gICAgICAgIC8vICAqIG1ldGFkYXRhIChuYW1lLCBkZXNjcmlwdGlvbilcbiAgICAgICAgLy8gICogdGhlIGluaXRpYWwgc2V0IG9mIGRhdGEgdGhhdCBkZWZpbmVzIHRoZSBkZWZhdWx0IHN0YXRlIG9mIGFcbiAgICAgICAgLy8gICAgbmV3bHkgaW5zdGFuY2lhdGVkIGNvbXBvbmVudFxuICAgICAgICB0aGlzLmNvbXBvbmVudHMgPSB7fTtcblxuICAgICAgICAvLyBBIGRpY3Rpb25hcnkgb2YgYXNzZW1ibGFnZXMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gYXNzZW1ibGFnZS4gQXNzZW1ibGFnZXMgYXJlIG9iamVjdHMgY29udGFpbmluZzpcbiAgICAgICAgLy8gICogbWV0YWRhdGEgKG5hbWUsIGRlc2NyaXB0aW9uKVxuICAgICAgICAvLyAgKiBhIGxpc3Qgb2YgY29tcG9uZW50cyB0byBhZGQgdG8gdGhlIGVudGl0eVxuICAgICAgICAvLyAgKiBhbiBpbml0aWFsIHN0YXRlIGZvciBzb21lIGNvbXBvbmVudHMsIHRvIG92ZXJyaWRlIHRoZSBkZWZhdWx0c1xuICAgICAgICB0aGlzLmFzc2VtYmxhZ2VzID0ge307XG5cbiAgICAgICAgLyohXG4gICAgICAgICAqIEEgcmVsYXRpb25hbC1saWtlIGxpc3Qgb2YgZW50aXR5IHN0YXRlcy4gVGhlcmUgaXMgb25lIGxpbmUgZm9yXG4gICAgICAgICAqIGVhY2ggZW50aXR5IC0gY29tcG9uZW50IGFzc29jaWF0aW9uLlxuICAgICAgICAgKlxuICAgICAgICAgKiBUbyBvcHRpbWl6ZSB0aGUgYWNjZXNzIHRpbWUgdG8gdGhpcyBkYXRhLCBpdCBpcyBzdG9yZWQgaW4gYVxuICAgICAgICAgKiBkaWN0aW9uYXJ5IG9mIGRpY3Rpb25hcmllcyBvZiB0aGlzIGZvcm06XG4gICAgICAgICAqIHtcbiAgICAgICAgICogICBcImNvbXBvbmVudElkXCI6IHtcbiAgICAgICAgICogICAgIFwiZW50aXR5SWRcIjoge1xuICAgICAgICAgKiAgICAgICAuLi5cbiAgICAgICAgICogICAgICAgaGVyZSBjb21lcyB0aGUgc3RhdGUgb2YgdGhpcyBlbnRpdHkgZm9yIHRoaXMgY29tcG9uZW50XG4gICAgICAgICAqICAgICAgIC4uLlxuICAgICAgICAgKiAgICAgfVxuICAgICAgICAgKiAgIH1cbiAgICAgICAgICogfVxuICAgICAgICAgKlxuICAgICAgICAgKiBUaGlzIHdheSwgZ2V0dGluZyB0aGUgZGF0YSBvZiBvbmUgZW50aXR5IGZvciBvbmUgY29tcG9uZW50IGlzOlxuICAgICAgICAgKiAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF1bZW50aXR5SWRdXG4gICAgICAgICAqIGFuZCBnZXR0aW5nIGFsbCBlbnRpdGllcyBmb3Igb25lIGNvbXBvbmVudCBpczpcbiAgICAgICAgICogICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGEgPSB7fTtcblxuICAgICAgICAvLyBUaGUgb3JkZXJlZCBsaXN0IG9mIHByb2Nlc3NvcnMga25vd24gYnkgdGhpcyBtYW5hZ2VyLlxuICAgICAgICB0aGlzLnByb2Nlc3NvcnMgPSBbXTtcblxuICAgICAgICAvLyBUaGUgbmV4dCB1bmlxdWUgaWRlbnRpZmllci5cbiAgICAgICAgdGhpcy51aWQgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhbiBpZGVudGlmaWVyIHVuaXF1ZSB0byB0aGlzIHN5c3RlbS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllci5cbiAgICAgKi9cbiAgICBnZXRVaWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVpZCsrO1xuICAgIH1cblxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIEVOVElUSUVTXG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5IGluIHRoZSBzeXN0ZW0gYnkgY3JlYXRpbmcgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBvZlxuICAgICAqIGl0cyBjb21wb25lbnRzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHthcnJheX0gY29tcG9uZW50SWRzIC0gTGlzdCBvZiBpZGVudGlmaWVycyBvZiB0aGUgY29tcG9uZW50cyB0aGF0IGNvbXBvc2UgdGhlIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gT3B0aW9uYWwuIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuIElmIHBhc3NlZCwgbm8gbmV3IGlkIHdpbGwgYmUgZ2VuZXJhdGVkLlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbmV3IGVudGl0eS5cbiAgICAgKi9cbiAgICBjcmVhdGVFbnRpdHkoY29tcG9uZW50SWRzLCBlbnRpdHlJZCkge1xuICAgICAgICBpZiAodHlwZW9mIGVudGl0eUlkID09PSAndW5kZWZpbmVkJyB8fCBlbnRpdHlJZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgZW50aXR5SWQgPSB0aGlzLmdldFVpZCgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGVudGl0eUlkID4gdGhpcy51aWQpIHtcbiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBhbm90aGVyIGVudGl0eSB3aXRoIHRoZSBzYW1lIElEIHdvbid0IGJlIGNyZWF0ZWQgaW4gdGhlIGZ1dHVyZS5cbiAgICAgICAgICAgIHRoaXMudWlkID0gZW50aXR5SWQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKTtcbiAgICAgICAgaWYgKCF0aGlzLmVudGl0aWVzLmluY2x1ZGVzKGVudGl0eUlkKSkge1xuICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5wdXNoKGVudGl0eUlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgLy8gU2lnbmFsIHRoZSBjcmVhdGlvbiBvZiBhIG5ldyBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBlbnRpdHlJZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVudGl0eUlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBlbnRpdHkgYW5kIGl0cyBpbnN0YW5jaWF0ZWQgY29tcG9uZW50cyBmcm9tIHRoZSBzeXN0ZW0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ludH0gaWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlRW50aXR5KGlkKSB7XG4gICAgICAgIC8vIFJlbW92ZSBhbGwgZGF0YSBmb3IgdGhpcyBlbnRpdHkuXG4gICAgICAgIGZvciAobGV0IGNvbXAgaW4gdGhpcy5lbnRpdHlDb21wb25lbnREYXRhKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5lbnRpdHlDb21wb25lbnREYXRhLmhhc093blByb3BlcnR5KGNvbXApKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBlbnRpdHkgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBlbnRpdGllcy5cbiAgICAgICAgdGhpcy5lbnRpdGllcy5zcGxpY2UodGhpcy5lbnRpdGllcy5pbmRleE9mKGlkKSwgMSk7XG5cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgcmVtb3ZhbCBvZiBhbiBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBpZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBDT01QT05FTlRTXG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBjb21wb25lbnQgdG8gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudCAtIE9iamVjdCBjb250YWluaW5nIHRoZSBtZXRhZGF0YSBhbmQgZGF0YSBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgYWRkQ29tcG9uZW50KGlkLCBjb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnRzW2lkXSA9IGNvbXBvbmVudDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGEgY29tcG9uZW50IGZyb20gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVDb21wb25lbnQoaWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuY29tcG9uZW50c1tpZF07XG4gICAgICAgIGRlbGV0ZSB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbaWRdO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxpc3Qgb2YgY29tcG9uZW50cyB0aGlzIGluc3RhbmNlIGtub3dzLlxuICAgICAqXG4gICAgICogQHJldHVybiB7YXJyYXl9IC0gTGlzdCBvZiBuYW1lcyBvZiBjb21wb25lbnRzLlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudHNMaXN0KCkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5jb21wb25lbnRzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBsaXN0ZWQgY29tcG9uZW50IGFuZCBhc3NvY2lhdGUgdGhlbVxuICAgICAqIHdpdGggdGhlIGVudGl0eS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGNvbXBvbmVudElkcyAtIExpc3Qgb2YgaWRlbnRpZmllcnMgb2YgdGhlIGNvbXBvbmVudHMgdG8gYWRkIHRvIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIC8vIEZpcnN0IHZlcmlmeSB0aGF0IGFsbCB0aGUgY29tcG9uZW50cyBleGlzdCwgYW5kIHRocm93IGFuIGVycm9yXG4gICAgICAgIC8vIGlmIGFueSBpcyB1bmtub3duLlxuICAgICAgICBjb21wb25lbnRJZHMuZm9yRWFjaChjb21wID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5jb21wb25lbnRzW2NvbXBdKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE5vdyB3ZSBrbm93IHRoYXQgdGhpcyByZXF1ZXN0IGlzIGNvcnJlY3QsIGxldCdzIGNyZWF0ZSB0aGUgbmV3XG4gICAgICAgIC8vIGVudGl0eSBhbmQgaW5zdGFuY2lhdGUgdGhlIGNvbXBvbmVudCdzIHN0YXRlcy5cbiAgICAgICAgY29tcG9uZW50SWRzLmZvckVhY2goY29tcCA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXSA9IHt9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgbmV3Q29tcFN0YXRlID0gbnVsbDtcblxuICAgICAgICAgICAgLy8gSWYgdGhlIG1hbmFnZXIgaGFzIGEgbGlzdGVuZXIsIHdlIHdhbnQgdG8gY3JlYXRlIGdldHRlcnNcbiAgICAgICAgICAgIC8vIGFuZCBzZXR0ZXJzIHNvIHRoYXQgd2UgY2FuIGVtaXQgc3RhdGUgY2hhbmdlcy4gQnV0IGlmIGl0IGRvZXNcbiAgICAgICAgICAgIC8vIG5vdCBoYXZlIG9uZSwgdGhlcmUgaXMgbm8gbmVlZCB0byBhZGQgdGhlIG92ZXJoZWFkLlxuICAgICAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgICAgICBuZXdDb21wU3RhdGUgPSB7fTtcbiAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKG5ld0NvbXBTdGF0ZSwgY29tcCkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdGUgPSBjbG9uZShzZWxmLmNvbXBvbmVudHNbY29tcF0uc3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhIHNldHRlciBmb3IgZWFjaCBzdGF0ZSBhdHRyaWJ1dGUsIHNvIHdlIGNhbiBlbWl0IGFuXG4gICAgICAgICAgICAgICAgICAgIC8vIGV2ZW50IHdoZW5ldmVyIHRoZSBzdGF0ZSBvZiB0aGlzIGNvbXBvbmVudCBjaGFuZ2VzLlxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBwcm9wZXJ0eSBpbiBzdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAocHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld0NvbXBTdGF0ZSwgcHJvcGVydHksIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGVbcHJvcGVydHldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW3Byb3BlcnR5XSA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNvbXBvbmVudFVwZGF0ZWQnLCBlbnRpdHlJZCwgY29tcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShwcm9wZXJ0eSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KShuZXdDb21wU3RhdGUsIGNvbXApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3Q29tcFN0YXRlID0gY2xvbmUoc2VsZi5jb21wb25lbnRzW2NvbXBdLnN0YXRlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gU3RvcmUgdGhlIGVudGl0eSdzIElEIHNvIGl0J3MgZWFzaWVyIHRvIGZpbmQgb3RoZXIgY29tcG9uZW50cyBmb3IgdGhhdCBlbnRpdHkuXG4gICAgICAgICAgICBuZXdDb21wU3RhdGUuX19pZCA9IGVudGl0eUlkO1xuXG4gICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF1bZW50aXR5SWRdID0gbmV3Q29tcFN0YXRlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgYWRkaXRpb24gb2YgYSBuZXcgY29tcG9uZW50IHRvIHRoZSBlbnRpdHkuXG4gICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5lbWl0KCdlbnRpdHlDb21wb25lbnRBZGRlZCcsIGVudGl0eUlkLCBjb21wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGUtYXNzb2NpYXRlIGEgbGlzdCBvZiBjb21wb25lbnRzIGZyb20gdGhlIGVudGl0eS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGNvbXBvbmVudElkcyAtIExpc3Qgb2YgaWRlbnRpZmllcnMgb2YgdGhlIGNvbXBvbmVudHMgdG8gcmVtb3ZlIGZyb20gdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge2ludH0gZW50aXR5SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlQ29tcG9uZW50c0Zyb21FbnRpdHkoY29tcG9uZW50SWRzLCBlbnRpdHlJZCkge1xuICAgICAgICAvLyBGaXJzdCB2ZXJpZnkgdGhhdCBhbGwgdGhlIGNvbXBvbmVudHMgZXhpc3QsIGFuZCB0aHJvdyBhbiBlcnJvclxuICAgICAgICAvLyBpZiBhbnkgaXMgdW5rbm93bi5cbiAgICAgICAgY29tcG9uZW50SWRzLmZvckVhY2goY29tcCA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY29tcG9uZW50c1tjb21wXSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGNvbXBvbmVudDogJyArIGNvbXApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBOb3cgd2Uga25vdyB0aGF0IHRoaXMgcmVxdWVzdCBpcyBjb3JyZWN0LCBsZXQncyByZW1vdmUgYWxsIHRoZVxuICAgICAgICAvLyBjb21wb25lbnRzJyBzdGF0ZXMgZm9yIHRoYXQgZW50aXR5LlxuICAgICAgICBjb21wb25lbnRJZHMuZm9yRWFjaChjb21wID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF0pIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBdW2VudGl0eUlkXSkge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBdW2VudGl0eUlkXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgY3JlYXRpb24gb2YgYSBuZXcgZW50aXR5LlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5lbWl0KCdlbnRpdHlDb21wb25lbnRSZW1vdmVkJywgZW50aXR5SWQsIGNvbXApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIHJlZmVyZW5jZSB0byBhbiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgZGF0YSBvZiBhblxuICAgICAqIGluc3RhbmNpYXRlZCBjb21wb25lbnQgb2YgYW4gZW50aXR5LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSBDb21wb25lbnQgZGF0YSBvZiBvbmUgZW50aXR5LlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudERhdGFGb3JFbnRpdHkoY29tcG9uZW50SWQsIGVudGl0eUlkKSB7XG4gICAgICAgIGlmICghKGNvbXBvbmVudElkIGluIHRoaXMuY29tcG9uZW50cykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGNvbXBvbmVudDogJyArIGNvbXBvbmVudElkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgICF0aGlzLmVudGl0eUNvbXBvbmVudERhdGEuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpIHx8XG4gICAgICAgICAgICAhdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBvbmVudElkXS5oYXNPd25Qcm9wZXJ0eShlbnRpdHlJZClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGRhdGEgZm9yIGNvbXBvbmVudCAnICsgY29tcG9uZW50SWQgKyAnIGFuZCBlbnRpdHkgJyArIGVudGl0eUlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdW2VudGl0eUlkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgdGhlIHN0YXRlIG9mIGEgY29tcG9uZW50LCBtYW55IGtleXMgYXQgb25jZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBlbnRpdHlJZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudElkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGNvbXBvbmVudC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gbmV3U3RhdGUgLSBPYmplY3QgY29udGFpbmluZyB0aGUgbmV3IHN0YXRlIHRvIGFwcGx5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgdXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eShjb21wb25lbnRJZCwgZW50aXR5SWQsIG5ld1N0YXRlKSB7XG4gICAgICAgIGNvbnN0IGNvbXBTdGF0ZSA9IHRoaXMuZ2V0Q29tcG9uZW50RGF0YUZvckVudGl0eShjb21wb25lbnRJZCwgZW50aXR5SWQpO1xuXG4gICAgICAgIGZvciAobGV0IGtleSBpbiBuZXdTdGF0ZSkge1xuICAgICAgICAgICAgaWYgKG5ld1N0YXRlLmhhc093blByb3BlcnR5KGtleSkgJiYgY29tcFN0YXRlLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICBjb21wU3RhdGVba2V5XSA9IG5ld1N0YXRlW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gYSBsaXN0IG9mIG9iamVjdHMgY29udGFpbmluZyB0aGUgZGF0YSBvZiBhbGwgb2YgYSBnaXZlbiBjb21wb25lbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge2FycmF5fSAtIExpc3Qgb2YgY29tcG9uZW50IGRhdGEgZm9yIG9uZSBjb21wb25lbnQuXG4gICAgICovXG4gICAgZ2V0Q29tcG9uZW50c0RhdGEoY29tcG9uZW50SWQpIHtcbiAgICAgICAgaWYgKCEoY29tcG9uZW50SWQgaW4gdGhpcy5jb21wb25lbnRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcG9uZW50SWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmVudGl0eUNvbXBvbmVudERhdGEuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBvbmVudElkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZW50aXR5IGhhcyB0aGUgY29tcG9uZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IC0gVHJ1ZSBpZiB0aGUgZW50aXR5IGhhcyB0aGUgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGVudGl0eUhhc0NvbXBvbmVudChlbnRpdHlJZCwgY29tcG9uZW50SWQpIHtcbiAgICAgICAgaWYgKCEoY29tcG9uZW50SWQgaW4gdGhpcy5jb21wb25lbnRzKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YS5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnRJZCkgJiZcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF0uaGFzT3duUHJvcGVydHkoZW50aXR5SWQpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gQVNTRU1CTEFHRVNcblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBhc3NlbWJsYWdlIHRvIHRoZSBsaXN0IG9mIGtub3duIGFzc2VtYmxhZ2VzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGFzc2VtYmxhZ2UuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGFzc2VtYmxhZ2UgLSBBbiBpbnN0YW5jZSBvZiBhbiBhc3NlbWJsYWdlIHRvIGFkZC5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZEFzc2VtYmxhZ2UoaWQsIGFzc2VtYmxhZ2UpIHtcbiAgICAgICAgdGhpcy5hc3NlbWJsYWdlc1tpZF0gPSBhc3NlbWJsYWdlO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gYXNzZW1ibGFnZSBmcm9tIHRoZSBsaXN0IG9mIGtub3duIGFzc2VtYmxhZ2VzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGFzc2VtYmxhZ2UuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVBc3NlbWJsYWdlKGlkKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmFzc2VtYmxhZ2VzW2lkXTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eSBpbiB0aGUgc3lzdGVtIGJ5IGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIG9mIGVhY2ggb2ZcbiAgICAgKiBpdHMgY29tcG9uZW50cyBhbmQgc2V0dGluZyB0aGVpciBpbml0aWFsIHN0YXRlLCB1c2luZyBhbiBhc3NlbWJsYWdlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFzc2VtYmxhZ2VJZCAtIElkIG9mIHRoZSBhc3NlbWJsYWdlIHRvIGNyZWF0ZSB0aGUgZW50aXR5IGZyb20uXG4gICAgICogQHJldHVybiB7aW50fSAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBuZXcgZW50aXR5LlxuICAgICAqL1xuICAgIGNyZWF0ZUVudGl0eUZyb21Bc3NlbWJsYWdlKGFzc2VtYmxhZ2VJZCkge1xuICAgICAgICBpZiAoIShhc3NlbWJsYWdlSWQgaW4gdGhpcy5hc3NlbWJsYWdlcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGFzc2VtYmxhZ2U6ICcgKyBhc3NlbWJsYWdlSWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXNzZW1ibGFnZSA9IHRoaXMuYXNzZW1ibGFnZXNbYXNzZW1ibGFnZUlkXTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5jcmVhdGVFbnRpdHkoYXNzZW1ibGFnZS5jb21wb25lbnRzKTtcblxuICAgICAgICBmb3IgKGxldCBjb21wIGluIGFzc2VtYmxhZ2UuaW5pdGlhbFN0YXRlKSB7XG4gICAgICAgICAgICBpZiAoYXNzZW1ibGFnZS5pbml0aWFsU3RhdGUuaGFzT3duUHJvcGVydHkoY29tcCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IGFzc2VtYmxhZ2UuaW5pdGlhbFN0YXRlW2NvbXBdO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eShjb21wLCBlbnRpdHksIG5ld1N0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gUFJPQ0VTU09SU1xuXG4gICAgLyoqXG4gICAgICogQWRkIGEgcHJvY2Vzc29yIHRvIHRoZSBsaXN0IG9mIGtub3duIHByb2Nlc3NvcnMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcHJvY2Vzc29yIC0gQW4gaW5zdGFuY2Ugb2YgYSBwcm9jZXNzb3IgdG8gbWFuYWdlLlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgYWRkUHJvY2Vzc29yKHByb2Nlc3Nvcikge1xuICAgICAgICB0aGlzLnByb2Nlc3NvcnMucHVzaChwcm9jZXNzb3IpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBwcm9jZXNzb3IgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBwcm9jZXNzb3JzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHByb2Nlc3NvciAtIEFuIGluc3RhbmNlIG9mIGEgcHJvY2Vzc29yIHRvIHJlbW92ZS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIHJlbW92ZVByb2Nlc3Nvcihwcm9jZXNzb3IpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzb3JzLnNwbGljZSh0aGlzLnByb2Nlc3NvcnMuaW5kZXhPZihwcm9jZXNzb3IpLCAxKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFsbCB0aGUga25vd24gcHJvY2Vzc29ycy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBkdCAtIFRoZSB0aW1lIGRlbHRhIHNpbmNlIHRoZSBsYXN0IGNhbGwgdG8gdXBkYXRlLiBXaWxsIGJlIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byBhbGwgcHJvY2Vzc29yJ3MgYHVwZGF0ZWAgbWV0aG9kLlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgdXBkYXRlKGR0KSB7XG4gICAgICAgIHRoaXMucHJvY2Vzc29ycy5mb3JFYWNoKHByb2Nlc3NvciA9PiBwcm9jZXNzb3IudXBkYXRlKGR0KSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRW50aXR5TWFuYWdlcjtcbiJdLCJuYW1lcyI6WyJjbG9uZSIsIm9iaiIsImNvcHkiLCJEYXRlIiwic2V0VGltZSIsImdldFRpbWUiLCJBcnJheSIsImkiLCJsZW4iLCJsZW5ndGgiLCJPYmplY3QiLCJhdHRyIiwiaGFzT3duUHJvcGVydHkiLCJpc0Z1bmN0aW9uIiwidGhpbmdUb0NoZWNrIiwidG9TdHJpbmciLCJjYWxsIiwibGlzdGVuZXIiLCJlbWl0IiwiZW50aXRpZXMiLCJjb21wb25lbnRzIiwiYXNzZW1ibGFnZXMiLCJlbnRpdHlDb21wb25lbnREYXRhIiwicHJvY2Vzc29ycyIsInVpZCIsInRoaXMiLCJjb21wb25lbnRJZHMiLCJlbnRpdHlJZCIsImdldFVpZCIsImFkZENvbXBvbmVudHNUb0VudGl0eSIsImluY2x1ZGVzIiwicHVzaCIsImlkIiwiY29tcCIsInNwbGljZSIsImluZGV4T2YiLCJjb21wb25lbnQiLCJrZXlzIiwic2VsZiIsImZvckVhY2giLCJfdGhpcyIsIkVycm9yIiwibmV3Q29tcFN0YXRlIiwic3RhdGUiLCJwcm9wZXJ0eSIsImRlZmluZVByb3BlcnR5IiwidmFsIiwiX19pZCIsIl90aGlzMiIsImNvbXBvbmVudElkIiwibmV3U3RhdGUiLCJjb21wU3RhdGUiLCJnZXRDb21wb25lbnREYXRhRm9yRW50aXR5Iiwia2V5IiwiYXNzZW1ibGFnZSIsImFzc2VtYmxhZ2VJZCIsImVudGl0eSIsImNyZWF0ZUVudGl0eSIsImluaXRpYWxTdGF0ZSIsInVwZGF0ZUNvbXBvbmVudERhdGFGb3JFbnRpdHkiLCJwcm9jZXNzb3IiLCJkdCIsInVwZGF0ZSJdLCJtYXBwaW5ncyI6IitLQWdCQSxTQUFTQSxHQUFNQyxNQUVQLE1BQVFBLEdBQU8sb0JBQW1CQSxnQkFBQUEsSUFBSyxNQUFPQSxNQUU5Q0MsYUFHQUQsWUFBZUUsZUFDUixHQUFJQSxRQUNOQyxRQUFRSCxFQUFJSSxXQUNWSCxLQUlQRCxZQUFlSyxPQUFPLFVBRWpCLEdBQUlDLEdBQUksRUFBR0MsRUFBTVAsRUFBSVEsT0FBUUYsRUFBSUMsRUFBS0QsTUFDbENBLEdBQUtQLEVBQU1DLEVBQUlNLFVBRWpCTCxNQUlQRCxZQUFlUyxRQUFRLFVBRWxCLEdBQUlDLEtBQVFWLEdBQ1RBLEVBQUlXLGVBQWVELEtBQU9ULEVBQUtTLEdBQVFYLEVBQU1DLEVBQUlVLFdB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
